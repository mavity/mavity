# 8.4.1 Debugging `gravity-mesh.js`

This document outlines the analysis and debugging plan for the particle simulation where particles are not moving when using the `gravity-mesh` method.

## Code Analysis Findings

Based on a review of `gravity-mesh.js`, `gravity-spectral.js`, and `gravity-monopole.js`, here are the initial findings:

1.  **`gravity-mesh.js` Structure**: This implementation correctly follows a Particle-Mesh (PM) approach with a near-field correction, making it a PÂ³M method. The steps are logically ordered:
    1.  `_depositMass`: Deposit particle mass onto a grid.
    2.  `_computeMeshForces`: Calculate long-range forces using FFT and a Poisson solver.
    3.  `_sampleForces`: Sample the long-range forces from the grid back to the particles.
    4.  `_computeNearField`: Calculate short-range forces directly between nearby particles.
    5.  `_integratePhysics`: Update particle positions and velocities.

2.  **Integration Step**: The `_integratePhysics` method in `gravity-mesh.js` correctly uses `KIntegrateEuler` to update particle positions and velocities. However, there is a critical omission: the `inForce` texture, which contains the computed forces, is not being passed to the integration kernel. It is currently `undefined`.

3.  **Force Calculation**:
    *   The long-range (mesh) forces are calculated and sampled by `_sampleForces`, with the result in `this.forceSampleKernel.outForce`.
    *   The short-range (near-field) forces are calculated by `_computeNearField` and accumulated into the same force texture using `this.nearFieldSampleKernel`. This kernel is correctly configured to accumulate (`accumulate: true`).

4.  **FFT Implementation**: The user noted that `k-fft.js` from the spectral method is more frugal. `gravity-mesh.js` appears to use a different, more resource-intensive FFT kernel. This is a valid point for optimization but is unlikely to be the cause of particles not moving. The primary issue is the missing force input to the integrator.

## Lines of Enquiry

1.  **Confirm the `inForce` Omission**: The main hypothesis is that `integrateEulerKernel.inForce` is `undefined` in `gravity-mesh.js`. This would result in zero force being applied, causing the particles to remain static or drift without acceleration. I will verify this by inspecting the `integrateEulerKernel` properties during runtime.

2.  **Verify Force Texture Content**: If fixing the `inForce` input does not resolve the issue, the next step is to ensure the force texture (`forceSampleKernel.outForce`) actually contains non-zero force data after the force calculation steps. This can be done by reading back the texture data on the GPU.

3.  **Check for WebGL Errors**: I will monitor the browser's developer console for any WebGL errors that might indicate a problem with one of the GPU kernels.

## Debugging and Fix Plan

1.  **Modify `gravity-mesh.js`**: I will edit `gravity-mesh.js` to correctly wire the output force texture from the sampling kernels to the input of the integration kernel.

2.  **Use Playwright for Live Debugging**: I will navigate to the provided demo page and use the browser's developer tools to execute JavaScript commands to:
    *   Switch the physics method to `mesh`.
    *   Inspect the `physics.system` object (which should be an instance of `GravityMesh`).
    *   Confirm that `integrateEulerKernel.inForce` is correctly set after the proposed fix.
    *   Observe the particle movement visually.
