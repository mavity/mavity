# 8.10 — Monopole Squeezy: Proportional, Aligned, and Adaptive

## Intent

Define the desired behavior of the Monopole method when faced with highly non-uniform mass distributions. The system shall maintain a strictly bounded and simple traversal while concentrating resolution where mass lives, avoiding cartesian explosion in sparse areas, and preserving numerical stability.

This document states the goal state the implementation must satisfy. It does not prescribe step-by-step changes.

## Core Principles

- Proportional resolution
  - The octree’s 3D voxelization is proportional to occupancy along each axis. Dense regions receive finer bins; sparse regions receive wider bins.
  - Proportionality applies at every level of the pyramid.

- Coarse-to-fine alignment
  - Each level’s voxel edges are aligned to its parent by coalescence of boundaries (every coarser edge is a subset of finer edges).
  - Parent–child coverage is exact and gapless; subdividing and summing preserves moments.

- Bounded traversal
  - Traversal remains level-ordered and MAC-driven, with a constant and small neighborhood for the near-field correction.
  - No new asymptotics are introduced. The method stays O(N · L) with small constants for practical scene sizes, where L is number of levels.

- Error-aware acceptance
  - Node acceptance depends on a conservative geometric size of the node and an appropriate distance measure to the particle.
  - Acceptance can be parameterized by a level-wise tolerance (theta) and/or an error proxy that scales with node mass and size.

- Stability over time
  - Spatial binning and acceptance parameters change slowly relative to frame rate to avoid force jitter.
  - The force field is free of discontinuities at voxel boundaries.

## Data Model (What exists)

- World bounds
  - Axis-aligned bounds that enclose all particles at each evaluation epoch.
  - May be tightened to high-percentile extents yet must remain conservative with guaranteed containment.

- Per-level axis edge tables
  - For each level l and axis a ∈ {x,y,z}, a strictly increasing set of edges Ea,l of length (Na,l + 1), defining Na,l bins along that axis.
  - Edges are aligned across levels: coarser edges coincide with a subset of finer edges.
  - Edges fully cover the world bounds with no gaps and no overlap.

- Moment textures per level
  - For every voxel at every level, the system stores monopole moments (Σm, Σ(m·x), Σ(m·y), Σ(m·z)).
  - These are defined in world coordinates and are independent of bin widths.

- Optional occupancy masks per level
  - Binary or fractional occupancy that indicates whether a voxel contributes mass.

## Mapping (How positions relate to voxels)

- Particle-to-voxel mapping
  - A particle’s world position maps to exactly one voxel per level by locating its interval index on each axis using the respective edge tables.
  - The mapping is deterministic and continuous with respect to the edges (no wrap, no aliasing, no clipping inside the bounds).

- Parent–child containment
  - A child voxel is always fully contained in a unique parent voxel. Summing child moments yields the parent’s moments exactly.

## Traversal Acceptance (When a node stands for its children)

- Geometric size
  - Each node carries an effective physical size s derived from its axis extents (e.g., max side length, or an equivalent bounding-sphere radius).

- Distance and interaction
  - The distance used for acceptance is the conservative distance from the particle to the node’s bounding volume (e.g., distance to the node’s AABB), not merely to the center of mass.

- Acceptance rules
  - Level-wise MAC: accept a node at level l when s/d < θ_l, with θ_l ∈ [θ_min, θ_max].
  - Error-targeted MAC (optional): accept when a node’s contribution proxy m · s² / d³ < ε, with ε a global error target; this implies a θ_l without naming it explicitly.
  - The chosen rule is monotone: once a node is accepted, its children are not visited.

- Near-field correction
  - Independently of acceptance, a small local neighborhood around the particle at the finest level (L0) is always evaluated directly using the available moments to ensure smoothness and accuracy.
  - The neighborhood is defined in physical space and covers a fixed, bounded radius.

## Adaptivity (How the system responds to bunching)

- Proportional edges
  - Axis edges at each level reflect mass occupancy along that axis so that voxels carry roughly comparable mass, subject to alignment constraints.

- Theta schedule
  - Coarser levels may use tighter acceptance (smaller θ_l) to prevent early over-acceptance across dense regions.
  - Finer levels may use a relaxed acceptance within an allowed envelope to control cost.

- Temporal smoothness
  - Edge tables and θ_l evolve with exponential smoothing or similar damping to ensure stability frame to frame.

## Invariants (What must always hold)

- Alignment: coarser edges are a subset of finer edges; no edge crossings; edges remain strictly increasing.
- Conservation: parent moments equal the exact sum of child moments.
- Boundedness: traversal performs a finite, bounded amount of work per particle per level; near-field neighborhood remains small and fixed in physical extent.
- Continuity: forces remain continuous in space and time given continuous inputs and stable edge evolution.
- Determinism: for a given state (edges, moments, bounds), traversal produces the same outputs irrespective of execution order.

## Quality Targets (What “good” looks like)

- Performance
  - In skewed/bunched scenes, total accepted-node visits per particle drop markedly versus uniform grids, with no increase in asymptotic complexity.
  - Acceptance ratios in coarse levels fall within a target band (e.g., 60–80%) under steady state.

- Accuracy
  - For representative benchmarks, force error versus direct summation stays below a prescribed tolerance at equal or lower cost compared to uniform-bin Monopole.
  - Energy and momentum remain stable over long runs within expected bounds for the integrator and softening.

- Robustness
  - No particle escapes world bounds unnoticed; bounds tighten safely without clipping.
  - No numerical instabilities from edge updates or acceptance changes; no NaN propagation.

## Interoperability (How it sits with the rest)

- Texture-first architecture
  - All state (positions, moments, edges, forces) resides in GPU textures; kernels communicate via textures and minimal uniforms.

- Compatibility
  - The same 3D→2D slice layout is preserved; proportional edges change only how indices are determined and how sizes are computed, not the texture packing.

- Fallback
  - If proportional edge tables are absent, the system defaults to isotropic uniform cells with the same acceptance semantics.

## Telemetry and Control (What is observable and steerable)

- Observability
  - Expose per-level acceptance ratios, average node sizes at acceptance, and a scalar bunching index per axis.
  - Expose effective θ_l (or ε) and near-field radius.

- Control
  - Provide high-level knobs: target acceptance band, error tolerance ε, θ envelope [θ_min, θ_max], near-field physical radius, edge update cadence and smoothing.

## Non-goals

- Exact error certification beyond Barnes–Hut-level proxies.
- Arbitrary, per-node non-aligned partitions (no k-d trees or free-form BSPs).
- Encoding implementation constraints or internal function names in this specification.

## Summary

Monopole Squeezy concentrates resolution where the mass is by making voxelization proportional and aligned across the pyramid, accepting nodes with geometry-aware and tolerance-aware criteria, and guaranteeing a bounded, simple traversal. It preserves the texture-first design, maintains deterministic and continuous forces, and exposes the minimal signals to observe and steer adaptivity without coupling the design to implementation details.
