## Multipole migration: reimplementing monopole & quadrupole with WebGL2 Kernels

This document is a pragmatic, actionable migration plan to rework the existing multipole particle systems (monopole and quadrupole) so they are implemented as collections of small, testable WebGL2 "Kernel" objects (see [8-webgl-kernels.md](8-webgl-kernels.md)). The goal is to preserve current multipole pipeline stages while gaining predictable resource ownership, simpler testing, and easier composition.

### Executive summary
- Swap out the current monolithic `particleSystem` logic for two classes—`ParticleSystemMonopole` and `ParticleSystemQuadrupole`—that orchestrate only multipole-related kernels.
- Implement each logical stage of monopole and quadrupole flows as independent Kernel classes following the exact constructor/run/dispose contract.
- Preserve shared CPU-side algorithms (traversal helpers, constants) but move all GPU work into explicit kernels.
- No shared base class.
- Avoid sharing unless necessary.

## Contract & engineering notes
- Each Kernel follows [8-webgl-kernels.md](8-webgl-kernels.md): `constructor(options)`, flat resource properties, synchronous `run()`, and `dispose()`.
- In constructor, any truthy or explicit `null` option means “do not create”; absent or falsy (except `null`) triggers default resource creation.
- Kernels do not perform typed-array uploads; callers create textures or pass `null` to defer creation.
- Ping-pong swaps are fully caller-owned; use `inX`/`outX` naming.#
- Each Kernel is a separate class, no base class or inheritance.

## High-level steps
1. Build low-level multipole kernels and add unit tests for each.
2. Implement `ParticleSystemMonopole` by composing kernels in order.
3. Implement `ParticleSystemQuadrupole`, reusing multipole kernels and adding quad-specific traversal.
4. Migrate existing tests to new classes and validate against [gravity-monopole/particle-system-monopole.js](../gravity-monopole/particle-system-monopole.js) and [gravity-quadrupole/particle-system-quadrupole.js](../gravity-quadrupole/particle-system-quadrupole.js).

## Kernel inventory (monopole & quadrupole flows)
- **AggregatorKernel** — pack and aggregate multipole moments ([gravity-quadrupole/aggregator.js](../gravity-quadrupole/aggregator.js)).
- **OccupancyKernel** — compute cell occupancy/weights ([gravity-quadrupole/occupancy.js](../gravity-quadrupole/occupancy.js)).
- **PyramidBuildKernel** — build hierarchical textures ([gravity-quadrupole/pyramid.js](../gravity-quadrupole/pyramid.js)).
- **TraversalKernel** — evaluate monopole traversal ([gravity-quadrupole/traversal.js](../gravity-quadrupole/traversal.js)).
- **TraversalQuadrupoleKernel** — quad-specific traversal & translation (same folder).
- **NearFieldKernel** — direct short-range corrections.
- **IntegrateVelocityKernel** — update velocity (see [utils/integrator.js](../utils/integrator.js)).
- **IntegratePositionKernel** — update position.
- **ReductionKernel** — small reductions for diagnostics.
- **RenderToScreenKernel** — debug/pass-through kernels ([gravity-quadrupole/debug](../gravity-quadrupole/debug)).

**Note:** Each stage should be its own Kernel for isolation and testability.

## Shared CPU modules
- Avoid gratuitious sharing, it hurts maintenance. If needed, decide explicitly what to share and make a shared module explicit in the name for what it has inside.

## Particle system wiring
`ParticleSystemMonopole` and `ParticleSystemQuadrupole`:
- Each class composes the kernels in a fixed pipeline: moments → traversal → near-field → integrate → output.
- Constructors accept `options` to supply or defer textures per kernel contract.
- Expose key texture slots (`inPosition`, `inVelocity`, `outPosition`, `outVelocity`) on the system for external orchestration.

### Monopole pseudo-wiring
1. `AggregatorKernel` / `PyramidBuildKernel` (particles → moments)
2. `TraversalKernel` (moments → force texture)
3. `NearFieldKernel` (force corrections)
4. `IntegrateVelocityKernel` (force + velocity → new velocity)
5. `IntegratePositionKernel` (position + velocity → new position)

Quadrupole inserts `TraversalQuadrupoleKernel` after build.

## Incremental plan
1. Create and test `IntegrateVelocityKernel` and `IntegratePositionKernel` on small 4×4 textures.
2. Implement and test `AggregatorKernel`, `OccupancyKernel`, `PyramidBuildKernel`.
3. Build `TraversalKernel` and integrate into `ParticleSystemMonopole`; validate against [gravity-monopole/particle-system-monopole.js](../gravity-monopole/particle-system-monopole.js).
4. Add `TraversalQuadrupoleKernel` to `ParticleSystemQuadrupole`.
5. Add smoke tests for `dispose()` and end-to-end regression tests versus existing systems.

## Testing & validation
- **Unit tests:** 4×4 or 8×8 textures, tolerance-based assertions for mass conservation and bounded quantities.
- **End-to-end:** fixed-seed runs comparing new vs existing multipole systems; allow small numeric differences.
- **Smoke:** call `dispose()` on all kernels and systems; ensure properties clear and no runtime errors.

## Edge cases & risks
- GPU float texture support (EXT_color_buffer_float) — tests must detect and skip or fallback.
- Numeric precision differences require tolerance in tests.
- `dispose()` deletes all non-null textures; callers must null properties to preserve external textures.

## Quality gates
- **Build:** no syntax or lint errors.
- **Lint:** maintain project style.
- **Tests:** unit and regression tests pass locally.

## Timeline (suggested)
- **Sprint 1:** core multipole kernels (Integrators, Aggregator, Pyramid, Occupancy).
- **Sprint 2:** monopole system implementation and validation.
- **Sprint 3:** quadrupole system implementation.

## Quick notes
- Pass `in*` as `null` to defer kernel input creation.
- Null out kernel properties before `dispose()` to retain external textures.

## Next steps
1. ✅ Implement first kernels (`Integrator`s and `AggregatorKernel`) with tests.
2. ✅ Wire `ParticleSystemMonopoleKernels` (new kernel-based implementation)
3. ⏭️ Verify regression tests against original `ParticleSystemMonopole`
4. ⏭️ Implement remaining kernels (NearField, Occupancy, TraversalQuadrupole)
5. ⏭️ Implement `ParticleSystemQuadrupoleKernels`

## Implementation Status (Updated)

### ✅ Completed
- IntegrateVelocityKernel (210 lines)
- IntegratePositionKernel (191 lines)
- AggregatorKernel (262 lines)
- PyramidBuildKernel (214 lines)
- TraversalKernel (273 lines)
- ParticleSystemMonopoleKernels (394 lines)
- Unit tests for integration kernels
- Test harness (kernel-tests.html)
- Documentation (README, IMPLEMENTATION_SUMMARY, MIGRATION_GUIDE)

**Total delivered**: 11 new files, ~2,122 lines of code + documentation

See `particle-system/kernels/README.md` and `particle-system/kernels/IMPLEMENTATION_SUMMARY.md` for details.

*** End***
