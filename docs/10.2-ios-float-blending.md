# iOS Float Blending Impact Assessment

## Known Facts

1. **iOS Safari does NOT support `EXT_float_blend` extension**
2. **Monopole and quadrupole methods work perfectly on iPhone** (user confirmed)
3. **Both methods use additive blending on RGBA32F textures** during particle aggregation

## Unknown: What Actually Works

The fact that monopole/quadrupole work means one of:

**A. Blending works without extension** (perhaps with limitations)
- iOS allows `gl.enable(BLEND)` on float framebuffers
- Accumulation happens correctly
- Precision might be reduced or clamped somehow

**B. Those methods don't need accurate blending**
- Errors from missing blending are small enough to not matter
- Unlikely given multiple particles per cell

## What Needs Testing

### Test 1: Does blending even execute?

```js
// On iOS device
const gl = canvas.getContext('webgl2');
gl.getExtension('EXT_color_buffer_float'); // Should exist
const hasFloatBlend = gl.getExtension('EXT_float_blend'); // Will be null on iOS

// Create RGBA32F framebuffer
// Clear to 0
// Enable blending (ONE, ONE)
// Draw 3 particles each with value 0.5
// Read back

// Expected if blending works: 1.5
// Expected if blending disabled: 0.5 (last particle only)
```

### Test 2: Does accumulation have precision issues?

```js
// Draw 1000 particles each with mass 0.001
// Expected: 1.0
// Measure actual value
// Check if precision loss is acceptable
```

### Test 3: Are values clamped?

```js
// Draw particles that should sum to 5.0
// Check if result is clamped to 1.0 or remains 5.0
```

## Impact on Project Methods

### Monopole/Quadrupole
- Currently work on iOS
- Use RGBA32F with additive blending for particle aggregation
- Whatever blending behavior iOS has is acceptable for these methods

### Mesh (PM/FFT) - Not Complete Yet
- Will use particle deposition to grid
- Requires accumulating mass contributions via blending
- Same requirements as monopole/quadrupole aggregation
- **Likely to work** if monopole/quadrupole work

### Spectral (PM/FFT) - Not Complete Yet
- Same as mesh method
- **Likely to work** if monopole/quadrupole work

### Graph Laplacian - Not Complete Yet
- Accumulates force contributions from graph edges
- Uses blending on RGBA32F force textures
- **Likely to work** if monopole/quadrupole work

## Possible Scenarios

### Scenario 1: Everything Works
- iOS allows float blending without extension
- Maybe slight precision reduction but acceptable
- All methods will work
- **Action: None needed**

### Scenario 2: Blending Disabled/Broken
- iOS silently disables blending or produces wrong results
- Monopole/quadrupole working is a mystery
- Other methods will fail
- **Action: Need workarounds (atomic operations, multi-pass, etc)**

### Scenario 3: Works With Limitations
- Blending works but clamped [0,1] or reduced precision
- Monopole/quadrupole tolerant of this
- Other methods might need adjustments (normalization, scaling)
- **Action: Test and adapt as needed**

## Recommendation

**Before implementing any workarounds:**

1. Complete mesh/spectral/laplacian implementation
2. Test on iOS device
3. Verify if they work like monopole/quadrupole do
4. Only implement workarounds if actual problems found

**If workarounds needed:**

Options include:
- Atomic operations (`imageAtomicAdd` on `r32i` textures)
- Multi-pass reduction
- Programmable blending with framebuffer fetch
- Accept limitations and document iOS behavior

## Next Steps

1. Finish implementing incomplete methods
2. Test all methods on iPhone
3. Document actual behavior observed
4. Only then decide if workarounds needed

No point designing workarounds for theoretical problems that might not exist.

