<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kernel Reflection Demo</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #1a1a1a;
            color: #00ff00;
        }
        
        h1 {
            color: #00ff00;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 10px;
        }
        
        h2 {
            color: #00ffaa;
            margin-top: 30px;
        }
        
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #0a0a0a;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        
        button {
            background: #003300;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: monospace;
            font-size: 14px;
            border-radius: 3px;
        }
        
        button:hover {
            background: #005500;
        }
        
        button:active {
            background: #007700;
        }
        
        #output {
            background: #0a0a0a;
            border: 1px solid #00ff00;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #00ff00;
            background: #001100;
        }
        
        .error {
            color: #ff0000;
            border-color: #ff0000;
            background: #110000;
        }
        
        .success {
            color: #00ff00;
        }
    </style>
</head>
<body>
    <h1>🔬 Kernel Reflection Demo</h1>
    
    <div class="status" id="status">
        Initializing WebGL2 context...
    </div>
    
    <div class="controls">
        <h2>Test Controls</h2>
        <button id="initKernel">Initialize KTraversal Kernel</button>
        <button id="runKernel">Run Kernel (1 frame)</button>
        <button id="valueOf">Call valueOf()</button>
        <button id="toString">Call toString()</button>
        <button id="clearOutput">Clear Output</button>
    </div>
    
    <h2>Output</h2>
    <pre id="output"></pre>
    
    <canvas id="canvas" width="256" height="256" style="display:none;"></canvas>
    
    <script type="module">
        import { KTraversal } from './particle-system/gravity-multipole/k-traversal.js';
        
        let gl = null;
        let kernel = null;
        let status = document.getElementById('status');
        let output = document.getElementById('output');
        
        function log(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = isError ? '❌ ' : '✅ ';
            output.textContent += `[${timestamp}] ${prefix}${message}\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function updateStatus(message, isError = false) {
            status.textContent = message;
            status.className = isError ? 'status error' : 'status success';
        }
        
        // Initialize WebGL2
        try {
            const canvas = document.getElementById('canvas');
            gl = canvas.getContext('webgl2');
            if (!gl) {
                throw new Error('WebGL2 not supported');
            }
            
            // Enable float textures
            const ext = gl.getExtension('EXT_color_buffer_float');
            if (!ext) {
                throw new Error('Float textures not supported');
            }
            
            updateStatus('WebGL2 initialized successfully');
            log('WebGL2 context created');
        } catch (error) {
            updateStatus(`Failed to initialize WebGL2: ${error.message}`, true);
            log(error.message, true);
        }
        
        // Button handlers
        document.getElementById('initKernel').addEventListener('click', () => {
            try {
                log('Initializing KTraversal kernel...');
                
                // Create some test textures
                const particleTexWidth = 64;
                const particleTexHeight = 64;
                const particleCount = particleTexWidth * particleTexHeight;
                
                // Create position texture with random data
                const positionTexture = gl.createTexture();
                gl.bindTexture(gl.TEXTURE_2D, positionTexture);
                const positionData = new Float32Array(particleCount * 4);
                for (let i = 0; i < particleCount; i++) {
                    positionData[i * 4 + 0] = (Math.random() - 0.5) * 10; // x
                    positionData[i * 4 + 1] = (Math.random() - 0.5) * 10; // y
                    positionData[i * 4 + 2] = (Math.random() - 0.5) * 10; // z
                    positionData[i * 4 + 3] = 1.0; // mass
                }
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA32F, particleTexWidth, particleTexHeight, 0, gl.RGBA, gl.FLOAT, positionData);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
                
                // Create force texture (output)
                const forceTexture = gl.createTexture();
                gl.bindTexture(gl.TEXTURE_2D, forceTexture);
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA32F, particleTexWidth, particleTexHeight, 0, gl.RGBA, gl.FLOAT, null);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
                
                // Create level textures (simplified)
                const levelA0 = [];
                for (let level = 0; level < 5; level++) {
                    const size = Math.pow(8, 5 - level);
                    const gridSize = Math.ceil(Math.pow(size, 1/3));
                    const texSize = gridSize * gridSize * gridSize;
                    const width = Math.ceil(Math.sqrt(texSize));
                    const height = width;
                    
                    const levelTexture = gl.createTexture();
                    gl.bindTexture(gl.TEXTURE_2D, levelTexture);
                    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA32F, width, height, 0, gl.RGBA, gl.FLOAT, null);
                    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
                    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
                    levelA0.push(levelTexture);
                }
                
                // Initialize kernel
                kernel = new KTraversal({
                    gl,
                    inPosition: positionTexture,
                    inLevelA0: levelA0,
                    outForce: forceTexture,
                    particleTexWidth,
                    particleTexHeight,
                    numLevels: 5,
                    levelConfigs: [
                        { size: 32768, gridSize: 32, slicesPerRow: 4 },
                        { size: 4096, gridSize: 16, slicesPerRow: 2 },
                        { size: 512, gridSize: 8, slicesPerRow: 1 },
                        { size: 64, gridSize: 4, slicesPerRow: 1 },
                        { size: 8, gridSize: 2, slicesPerRow: 1 }
                    ],
                    theta: 0.5,
                    gravityStrength: 0.0003,
                    softening: 0.2
                });
                
                updateStatus('KTraversal kernel initialized');
                log(`Kernel created with ${particleCount} particles`);
                log('Kernel properties:');
                log(`  - valueOf: ${typeof kernel.valueOf}`);
                log(`  - toString: ${typeof kernel.toString}`);
                
            } catch (error) {
                updateStatus(`Failed to initialize kernel: ${error.message}`, true);
                log(error.stack || error.message, true);
            }
        });
        
        document.getElementById('runKernel').addEventListener('click', () => {
            if (!kernel) {
                log('Kernel not initialized!', true);
                return;
            }
            
            try {
                log('Running kernel.run()...');
                const result = kernel.run();
                log(`Kernel executed successfully`);
                log(`Render count: ${result.renderCount}`);
                updateStatus('Kernel executed');
            } catch (error) {
                log(`Failed to run kernel: ${error.message}`, true);
                updateStatus(`Kernel execution failed: ${error.message}`, true);
            }
        });
        
        document.getElementById('valueOf').addEventListener('click', () => {
            if (!kernel) {
                log('Kernel not initialized!', true);
                return;
            }
            
            try {
                log('Calling kernel.valueOf()...');
                const snapshot = kernel.valueOf();
                log('valueOf() returned:');
                log(JSON.stringify(snapshot, (key, value) => {
                    // Skip functions and very large arrays in JSON output
                    if (typeof value === 'function') return '[Function]';
                    if (Array.isArray(value) && value.length > 10) {
                        return `[Array(${value.length})]`;
                    }
                    return value;
                }, 2));
                
                updateStatus('valueOf() completed');
            } catch (error) {
                log(`valueOf() failed: ${error.message}`, true);
                log(error.stack || '', true);
                updateStatus(`valueOf() failed: ${error.message}`, true);
            }
        });
        
        document.getElementById('toString').addEventListener('click', () => {
            if (!kernel) {
                log('Kernel not initialized!', true);
                return;
            }
            
            try {
                log('Calling kernel.toString()...');
                const result = kernel.toString();
                log('toString() returned:\n');
                log('─'.repeat(60));
                log(result);
                log('─'.repeat(60));
                updateStatus('toString() completed');
            } catch (error) {
                log(`toString() failed: ${error.message}`, true);
                log(error.stack || '', true);
                updateStatus(`toString() failed: ${error.message}`, true);
            }
        });
        
        document.getElementById('clearOutput').addEventListener('click', () => {
            output.textContent = '';
            log('Output cleared');
        });
        
        // Auto-initialize on load
        window.addEventListener('load', () => {
            log('Page loaded, ready for testing');
        });
    </script>
</body>
</html>
